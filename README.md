# Психологический Telegram Бот

Telegram бот для психологических консультаций и создания психологических карт с использованием OpenAI GPT-3.5-turbo.

## Функциональность

### Для пользователей:
1. **Психологическая консультация** - получение профессиональной консультации от ИИ-психолога
2. **Создание психологической карты** - прохождение опроса и получение персональной психологической карты

### Для администратора:
- Модерация созданных карт
- Одобрение/отклонение карт
- Отправка результатов пользователям

## Структура проекта

```
bot_test_py/
├── run.py                 # Основной файл для запуска на хостинге
├── run_admin.py           # Файл для запуска админской панели
├── bot_polling.py         # Основной бот (polling)
├── admin_polling.py       # Админская панель (polling)
├── config.py              # Конфигурация и настройки
├── database.py            # Работа с базой данных
├── openai_client.py       # Интеграция с OpenAI API
├── local_responses.py     # Локальная система ответов (fallback)
├── monitor_rate_limits.py # Мониторинг rate limits OpenAI
├── check_openai_balance.py # Проверка баланса OpenAI
├── requirements.txt       # Зависимости Python
├── database.json          # База данных (создается автоматически)
└── README.md             # Документация
```

## Установка и настройка

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Создайте файл `.env` или установите переменные окружения:

```env
BOT_TOKEN=ваш_telegram_токен
OPENAI_API_KEY=ваш_openai_ключ
```

### 3. Запуск бота

#### Локальная разработка:
```bash
# Основной бот
python3 bot_polling.py

# Админская панель (в отдельном терминале)
python3 admin_polling.py
```

#### На хостинге:
```bash
# Основной бот
python3 run.py

# Админская панель
python3 run_admin.py
```

## Развертывание на хостинге

### 1. Подготовка файлов
Убедитесь, что у вас есть все необходимые файлы:
- `run.py` - основной файл запуска
- `run_admin.py` - файл запуска админской панели
- `requirements.txt` - зависимости
- `.env` - переменные окружения

### 2. Настройка переменных окружения
На хостинге установите переменные окружения:
- `BOT_TOKEN` - токен Telegram бота
- `OPENAI_API_KEY` - ключ OpenAI API

### 3. Запуск
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск основного бота
python3 run.py
```

## Использование

### Для пользователей:
1. Отправьте `/start` боту
2. Выберите нужную опцию:
   - "1️⃣ Получить консультацию" - для консультации
   - "2️⃣ Создать психологическую карту" - для создания карты

### Для администратора:
- `/admin` - открыть админ-панель
- `/pending` - показать карты на модерации
- Используйте кнопки для одобрения/отклонения карт

## База данных

Данные хранятся в JSON файле `database.json`:
- Состояния пользователей
- Психологические карты
- Статусы модерации

## Безопасность

- Все чувствительные данные хранятся в переменных окружения
- Проверка прав доступа для админских функций
- Модерация контента через OpenAI API

## Логирование

Все действия логируются с указанием времени и уровня важности.

## Rate Limiting и мониторинг

### Улучшения для обработки 429 ошибок:

1. **Rate Limiter класс** - автоматически ограничивает количество запросов к OpenAI API
2. **Экспоненциальная задержка** - увеличивает время ожидания при ошибках
3. **Пользовательский rate limiting** - предотвращает спам от отдельных пользователей
4. **Улучшенная обработка ошибок** - более информативные сообщения пользователям

### Мониторинг rate limits:

```bash
# Запуск мониторинга OpenAI API
python3 monitor_rate_limits.py
```

Мониторинг показывает:
- Текущие rate limits
- Оставшиеся запросы
- Время сброса лимитов
- Статистику использования API

### Настройки rate limiting:

В `openai_client.py` можно настроить:
- `max_requests_per_minute` - максимальное количество запросов в минуту (90 для GPT-3.5-turbo)
- `max_retries` - количество повторных попыток при ошибках
- `base_delay` - базовая задержка между попытками

## Поддержка

При возникновении проблем проверьте:
1. Правильность токенов в переменных окружения
2. Доступность OpenAI API
3. Логи приложения для диагностики ошибок
4. Rate limits через мониторинг

## Исправления

### Проблема с нейросетью:
- Исправлены асинхронные вызовы в `openai_client.py`
- Методы теперь синхронные и работают корректно
- Добавлена retry логика для обработки ошибок OpenAI
- Убраны лишние файлы для чистоты проекта

### Проблема с конфликтом экземпляров:
- Добавлен `drop_pending_updates=True` для игнорирования старых сообщений
- Добавлен обработчик ошибок
- Создан скрипт `stop_bot.sh` для остановки всех экземпляров

### Проблема с 429 ошибками (Rate Limit):
- Переход на GPT-3.5-turbo для более высоких лимитов запросов
- Добавлен класс `RateLimiter` для управления запросами
- Реализована экспоненциальная задержка с джиттером
- Добавлен пользовательский rate limiting (10 секунд между запросами)
- Создан скрипт мониторинга `monitor_rate_limits.py`
- Улучшена обработка ошибок с более информативными сообщениями

### Проблема с географическими ограничениями:
- Создана локальная система ответов `local_responses.py` как fallback
- Автоматическое переключение на локальные ответы при недоступности OpenAI
- Умный анализ ключевых слов для релевантных ответов
- Локальная генерация психологических карт
- Проверка баланса и статуса аккаунта через `check_openai_balance.py`

## Устранение неполадок

### Ошибка "Conflict: terminated by other getUpdates request"
```bash
# Остановите все экземпляры бота
./stop_bot.sh

# Запустите заново
python3 run.py
```

### Проблемы с OpenAI API (429 ошибки)
```bash
# Проверьте текущие rate limits
python3 monitor_rate_limits.py

# Если лимиты исчерпаны, подождите или:
# 1. Уменьшите количество запросов в минуту в openai_client.py
# 2. Увеличьте интервал между запросами пользователей
```

### Географические ограничения OpenAI
```bash
# Проверьте статус аккаунта
python3 check_openai_balance.py

# Если OpenAI недоступен в вашем регионе:
# Бот автоматически переключится на локальную систему ответов
# Локальные ответы работают без интернета и API ключей
```

### Бот не отвечает
1. Проверьте логи на ошибки
2. Убедитесь, что переменные окружения установлены
3. Перезапустите бота: `./stop_bot.sh && python3 run.py`
4. Проверьте rate limits: `python3 monitor_rate_limits.py` 